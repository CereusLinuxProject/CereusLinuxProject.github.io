<!--BANNER-->
<link rel="stylesheet" href="{{ "css/updates.css" | relURL }}">

<section class="header-upt">
	<div class="weltext">
		<p id="str-extrasubtitle">This page contains last 15 commits in Cereus Linux codeberg organization</p>
		<section class="post-card">
			<a href="https://codeberg.org/cereus-linux.rss"><h1>Suscribe to Codeberg feed (RSS)</h1></a>
		</section>
		<h1>Recent Commits</h1>
	</div>
</section>
<br>

<div id="commit-feed"></div>


<script>
async function fetchCommits(url) {
	try {
		const response = await fetch(url);
		const data = await response.json();
		const container = document.getElementById("commit-feed");

		data
			.filter(entry => entry.op_type === "commit_repo")
			.slice(0, 15)
			.forEach(entry => {
				const user = entry.act_user;
				const repo = entry.repo;
				let content = null;
				let commits = [];

				try {
					content = JSON.parse(entry.content);
					if (content && Array.isArray(content.Commits)) {
						commits = content.Commits;
					}
				} catch (e) {
					console.warn("Invalid JSON in content:", entry.content);
					return;
				}

				commits.forEach(commit => {
					const commitUrl = "https://codeberg.org/" + repo.full_name + "/commit/" + commit.Sha1;
					const message = commit.Message || "";

					// First line is title, rest is body
					const lines = message.split(/\r?\n+/);
					const title = lines[0].trim();
					const body = lines.length > 1 ? lines[1].trim() : "";

					// Create table and elements manually
					const table = document.createElement("table");
					table.className = "commit-table";

					const tr = document.createElement("tr");

					const tdUser = document.createElement("td");
					const img = document.createElement("img");
					img.src = user.avatar_url;
					img.alt = "avatar";
					tdUser.appendChild(img);

					const h3 = document.createElement("h3");
					const aUser = document.createElement("a");
					aUser.href = user.html_url;
					aUser.target = "_blank";
					aUser.textContent = user.full_name || user.login;
					h3.appendChild(aUser);
					tdUser.appendChild(h3);

					const tdRepo = document.createElement("td");
					const h2 = document.createElement("h2");
					h2.textContent = repo.full_name;
					tdRepo.appendChild(h2);

					const hr = document.createElement("hr");
					tdRepo.appendChild(hr);

					const h4 = document.createElement("h4");
					const aCommit = document.createElement("a");
					aCommit.href = commitUrl;
					aCommit.className = "commit-title";
					aCommit.target = "_blank";
					aCommit.textContent = title;
					h4.appendChild(aCommit);
					tdRepo.appendChild(h4);

					if (body) {
						const p = document.createElement("p");
						p.textContent = body;
						tdRepo.appendChild(p);
					}

					const div = document.createElement("div");
					const aDate = document.createElement("a");
					aDate.href = commitUrl;
					aDate.className = "commit-date-button";
					aDate.target = "_blank";
					aDate.textContent = new Date(commit.Timestamp || entry.created).toLocaleString();
					div.appendChild(aDate);
					tdRepo.appendChild(div);

					tr.appendChild(tdUser);
					tr.appendChild(tdRepo);
					table.appendChild(tr);
					container.appendChild(table);
				});
			});
	} catch (error) {
		console.error("Error fetching commits:", error);
	}
}

fetchCommits("https://codeberg.org/api/v1/orgs/cereus-linux/activities/feeds");
</script>

